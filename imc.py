import datetime
from dateutil.relativedelta import relativedelta


def get_imc(talla, peso):

    if not talla or not peso:
        return None

    imc = round(peso / (talla/100) ** 2, 1)
    return imc


def interpret_imc_kids(talla, peso, fecha, sex):

    imc = get_imc(talla, peso)
    if not imc:
        return None, 'Talla o peso incorrectos'

    if fecha:
        edad = relativedelta(datetime.date.today(), fecha)
    else:
        return None, 'Fecha de nacimiento incorrecta'

    edad_meses = edad.years * 12 + edad.months
    parametro = edad.months > 6

    if sex == 'h':
        dict_imc_kids = dct_imc_niños_5_18_años
    else:
        dict_imc_kids = dct_imc_niñas_5_18_años

    try:
        lst_valores_imc = dict_imc_kids[(edad.years, parametro)]
    except KeyError:
        return None, 'Edad invalida ({} años con {} meses)'.format(edad.years, edad.months)

    ds, dm, n, s, o = lst_valores_imc
    dm0, dm1 = dm
    n0, n1 = n
    s0, s1 = s

    if imc < ds:
        mensaje = 'desnutricion severa'
    elif dm0 <= imc <= dm1:
        mensaje = 'desnutricion moderada'
    elif n0 <= imc <= n1:
        mensaje = 'normal'
    elif s0 <= imc <= s1:
        mensaje = 'sobrepeso'
    elif imc >= o:
        mensaje = 'obesidad'

    return imc, mensaje


def interpret_imc(talla, peso):
    imc = get_imc(talla, peso)

    if imc < 16:
        mensaje = 'desnutricion severa'
    elif 16 <= imc < 17:
        mensaje = 'desnutricion moderada'
    elif 17 <= imc < 18.5:
        mensaje = 'desnutricion leve'
    elif 18.5 <= imc < 25:
        mensaje = 'normal'
    elif 25 <= imc < 30:
        mensaje = 'sobrepeso'
    elif imc >= 30:
        mensaje = 'obesidad'
    else:
        mensaje = 'Error: IMC = {}, talla = {}, peso = {}'.format(
            imc, talla, peso
        )

    return imc, mensaje


dct_imc_niñas_5_18_años = {
    (5, 0): [11.8, (11.8, 12.6), (12.7, 16.9), (17.0, 18.9), 19.0],
    (5, 1): [11.7, (11.7, 12.6), (12.7, 16.9), (17.0, 19.0), 19.1],
    (6, 0): [11.7, (11.7, 12.6), (12.7, 17.0), (17.1, 19.2), 19.3],
    (6, 1): [11.7, (11.7, 12.6), (12.7, 17.1), (17.2, 19.5), 19.6],
    (7, 0): [11.8, (11.8, 12.6), (12.7, 17.3), (17.4, 19.8), 19.9],
    (7, 1): [11.8, (11.8, 12.7), (12.8, 17.5), (17.6, 20.1), 20.2],
    (8, 0): [11.9, (11.9, 12.8), (12.9, 17.7), (17.8, 20.6), 20.7],
    (8, 1): [12.0, (12.0, 12.9), (13.0, 18.0), (18.1, 21.0), 21.1],
    (9, 0): [12.1, (12.1, 13.0), (13.1, 18.3), (18.4, 21.5), 21.6],
    (9, 1): [12.2, (12.2, 13.2), (13.3, 18.7), (18.8, 22.0), 22.1],
    (10, 0): [12.4, (12.4, 13.4), (13.5, 19.0), (19.1, 22.6), 22.7],
    (10, 1): [12.5, (12.5, 13.6), (13.7, 19.4), (19.5, 23.1), 23.2],
    (11, 0): [12.7, (12.7, 13.8), (13.9, 19.9), (20.0, 23.7), 23.8],
    (11, 1): [12.9, (12.9, 14.0), (14.1, 20.3), (20.4, 24.3), 24.4],
    (12, 0): [13.2, (13.2, 14.3), (14.4, 20.8), (20.9, 25.0), 25.1],
    (12, 1): [13.4, (13.4, 14.6), (14.7, 21.3), (21.4, 25.6), 25.7],
    (13, 0): [13.6, (13.6, 14.8), (14.9, 21.8), (21.9, 26.2), 26.3],
    (13, 1): [13.8, (13.8, 15.1), (15.2, 22.3), (22.4, 26.8), 26.9],
    (14, 0): [14.0, (14.0, 15.3), (15.4, 22.7), (22.8, 27.3), 27.4],
    (14, 1): [14.2, (14.2, 15.6), (15.7, 23.1), (23.2, 27.8), 27.9],
    (15, 0): [14.4, (14.4, 15.8), (15.9, 23.5), (23.6, 28.2), 28.3],
    (15, 1): [14.5, (14.5, 15.9), (16.0, 23.8), (23.9, 28.6), 28.7],
    (16, 0): [14.6, (14.6, 16.1), (16.2, 24.1), (24.2, 28.9), 29.0],
    (16, 1): [14.7, (14.7, 16.2), (16.3, 24.3), (24.4, 29.1), 29.2],
    (17, 0): [14.7, (14.7, 16.3), (16.4, 24.5), (24.6, 29.3), 29.4],
    (17, 1): [14.7, (14.7, 16.3), (16.4, 24.6), (24.7, 29.4), 29.5],
    (18, 0): [14.7, (14.7, 16.3), (16.4, 24.8), (24.9, 29.5), 29.6]
}

dct_imc_niños_5_18_años = {
    (5, 0): [12.1, (12.1, 12.9), (13.0, 16.6), (16.7, 18.3), 18.4],
    (5, 1): [12.1, (12.1, 12.9), (13.0, 16.7), (16.8, 18.4), 18.5],
    (6, 0): [12.1, (12.1, 12.9), (13.0, 16.8), (16.9, 18.5), 18.6],
    (6, 1): [12.2, (12.2, 13.0), (13.1, 16.9), (17.0, 18.7), 18.8],
    (7, 0): [12.3, (12.3, 13.0), (13.1, 17.0), (17.1, 19.0), 19.1],
    (7, 1): [12.3, (12.3, 13.1), (13.2, 17.2), (17.3, 19.3), 19.4],
    (8, 0): [12.4, (12.4, 13.2), (13.3, 17.4), (17.5, 19.7), 19.8],
    (8, 1): [12.5, (12.5, 13.3), (13.4, 17.7), (17.8, 20.1), 20.2],
    (9, 0): [12.6, (12.6, 13.4), (13.5, 17.9), (18.0, 20.5), 20.6],
    (9, 1): [12.7, (12.7, 13.5), (13.6, 18.2), (18.3, 20.9), 21.0],
    (10, 0): [12.8, (12.8, 13.6), (13.7, 18.5), (18.6, 21.4), 21.5],
    (10, 1): [12.9, (12.9, 13.8), (13.9, 18.8), (18.9, 21.9), 22.0],
    (11, 0): [13.1, (13.1, 14.0), (14.1, 19.2), (19.3, 22.5), 22.6],
    (11, 1): [13.2, (13.2, 14.1), (14.2, 19.5), (19.6, 23.0), 23.1],
    (12, 0): [13.4, (13.4, 14.4), (14.5, 19.9), (20.0, 23.6), 23.7],
    (12, 1): [13.6, (13.6, 14.6), (14.7, 20.4), (20.5, 24.2), 24.3],
    (13, 0): [13.8, (13.8, 14.8), (14.9, 20.8), (20.9, 24.8), 24.9],
    (13, 1): [14.0, (14.0, 15.1), (15.2, 21.3), (21.4, 25.3), 25.4],
    (14, 0): [14.3, (14.3, 15.4), (15.5, 21.8), (21.9, 25.9), 26.0],
    (14, 1): [14.5, (14.5, 15.6), (15.7, 22.2), (22.3, 26.5), 26.6],
    (15, 0): [14.7, (14.7, 15.9), (16.0, 22.7), (22.8, 27.0), 27.1],
    (15, 1): [14.9, (14.9, 16.2), (16.3, 23.1), (23.2, 27.4), 27.5],
    (16, 0): [15.1, (15.1, 16.4), (16.5, 23.5), (23.6, 27.9), 28.0],
    (16, 1): [15.3, (15.3, 16.6), (16.7, 23.9), (24.0, 28.3), 28.4],
    (17, 0): [15.4, (15.4, 16.8), (16.9, 24.3), (24.4, 28.6), 28.7],
    (17, 1): [15.6, (15.6, 17.0), (17.1, 24.6), (24.7, 29.0), 29.1],
    (18, 0): [15.7, (15.7, 17.2), (17.3, 24.9), (25.0, 29.2), 29.3]
}
